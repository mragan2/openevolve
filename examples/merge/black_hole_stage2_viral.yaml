# Stage 2: Aggressive Optimization WITH VIRAL TRANSFER
# Goal: Break through performance plateaus with proven baselines
# Strategy: Higher temperature, larger population, exploration focus + VIRAL CODE SPREAD
# 
# This config is identical to black_hole_stage2.yaml but adds retroviral code transfer
# for rapid horizontal spread of successful innovations across islands.

random_seed: 43              # Same seed for fair comparison
log_level: "INFO"
output_dir: "output"

# Concurrency overrides for TaskManager
gen_semaphore: 2
eval_semaphore: 2

# -----------------------------------------------------------------
# Stage 2 EA settings - Aggressive
# -----------------------------------------------------------------
population_size: 40          # Larger population for diversity
max_generations: 30          # More generations for refinement

# -----------------------------------------------------------------
# LLM configuration - Higher temperature for creativity
# -----------------------------------------------------------------
llm:
  default_block: local

  local:
    api_host: "http://localhost"
    api_base: "http://localhost:11434/v1"
    temperature: 0.7         # Higher for creative solutions
    max_tokens: 2048         # More tokens for complex code
    timeout: 90

  cloud:
    api_key: "${OLLAMA_API_KEY}"
    api_host: "https://ollama.com"
    api_base: "https://ollama.com/v1"
    temperature: 0.7
    max_tokens: 2048
    timeout: 90

  agent_models:
    code_generator: "deepseek-r1:7b"
    prompt_designer: "llama3.2:3b"
    evaluator: "gpt-oss:120b-cloud"
    selection: "gemma2:9b"
    task_manager: "mistral:7b"
    viral_repair: "gemma2:2b"  # ü¶† Small, fast, realistic error-prone repair

  per_agent_params:
    code_generator: {block: local, temperature: 0.40, max_tokens: 2048, timeout: 90, max_attempts: 4}
    prompt_designer: {block: local, temperature: 0.8, max_tokens: 1024}
    selection: {block: local, temperature: 0.3, max_tokens: 512}
    task_manager: {block: local, temperature: 0.4, max_tokens: 512}
    evaluator:
      block: cloud
      temperature: 0.2
      max_tokens: 2048
      timeout: 90
      think: "medium"

# -----------------------------------------------------------------
# Stage 2 Evolutionary parameters - Exploration focus
# -----------------------------------------------------------------
evolutionary:
  elitism_count: 3           # Less elitism for more exploration
  mutation_rate: 0.55        # Higher mutation for breakthrough
  tournament_size: 5         # Larger tournament for quality

# -----------------------------------------------------------------
# Islands configuration (ENABLED for Stage 2)
# -----------------------------------------------------------------
islands:
  enabled: true
  num_islands: 4
  migration_interval: 5
  migration_size: 2

# -----------------------------------------------------------------
# ü¶† VIRAL TRANSFER CONFIGURATION (NEW!) ü¶†
# Horizontal gene transfer for rapid innovation spread
# -----------------------------------------------------------------
viral_transfer:
  enabled: true
  
  # Infection schedule
  infection_frequency: 2     # Apply viral infection every 2 generations
                             # More frequent than migration (every 5 gens)
  
  # Infection intensity
  infection_rate: 0.15       # 15% of population infected per cycle
                             # 40 individuals √ó 0.15 = 6 individuals per island
                             # Total: ~24 infections per cycle across 4 islands
  
  # Viral sources
  donor_count: 3             # Top 3 fittest individuals become viral donors
                             # Extract their best functions to spread
  
  # Insertion parameters
  insertions_per_host: 1     # One function inserted per infection
                             # Conservative to avoid overwhelming hosts
                             # 
                             # SAFE INSERTION POINTS:
                             # Viral code only inserted at clean boundaries:
                             #   ‚úÖ After complete functions
                             #   ‚úÖ After import statements  
                             #   ‚úÖ At beginning/end of file
                             #   ‚ùå NEVER mid-line or mid-statement
                             # This makes repair much easier!
  
  # Cross-island infection
  cross_island: true         # Allow viral spread between islands
                             # KEY ADVANTAGE: Innovations spread globally
                             # without waiting for migration events
  
  # Island immunity (RECOMMENDED!)
  island_immunity: true      # üõ°Ô∏è Hosts are IMMUNE to viruses from their own island
                             # Only FOREIGN viruses can infect
                             # BENEFITS:
                             #   - Prevents redundant local infections (code already similar)
                             #   - Forces cross-island diversity exchange
                             #   - Each island becomes specialized viral niche
                             #   - Maximizes innovation from different populations
  
  # Quality control
  min_fitness_threshold: 0.75  # Only high-quality donors (0.75+ fitness)
                               # Prevents spreading mediocre code
  
  # Tracking and analysis
  track_lineage: true        # Record which functions came from where
                             # Enables post-analysis of viral genealogy
  
  # Repair system (auto-fix broken insertions)
  enable_repair: true        # Attempt to repair syntax errors
                             # THREE-TIER REPAIR:
                             #   1. Simple heuristics (fast, free)
                             #   2. LLM repair (gemma2:2b)
                             #   3. Snippet removal (safe fallback)
  
  enable_llm_repair: true    # ü§ñ Use gemma2:2b as repair agent
                             # Activates when heuristics fail
                             # Prone to errors (realistic!)
                             # ~1-2 second overhead per repair
  
  # Logging
  log_viral_stats: true      # Log infection statistics each generation

# -----------------------------------------------------------------
# Database MAP-Elites settings - Larger archive
# -----------------------------------------------------------------
database:
  feature_dimensions:
    - "complexity"
    - "diversity"
    - "performance"
    - "accuracy"
  archive_size: 50           # Larger archive for stage 2

# -----------------------------------------------------------------
# Checkpointing
# -----------------------------------------------------------------
checkpoint:
  interval: 5                # Persist best program every 5 generations

# -----------------------------------------------------------------
# Evaluation pipeline - Full evaluation with rich artifacts
# -----------------------------------------------------------------
evaluator:
  enable_artifacts: true         # Capture detailed execution feedback
  cascade_evaluation: true
  cascade_thresholds: [0.6, 0.8]  # Stricter thresholds
  use_llm_feedback: true         # Enable LLM-based improvement suggestions
  artifact_detail_level: "high"  # Include all diagnostic information

# -----------------------------------------------------------------
# Prompt curation - Diversity focus
# -----------------------------------------------------------------
prompt:
  num_top_programs: 4
  num_diverse_programs: 3
  include_artifacts: true
  template_dir: "custom_prompts/"
  use_template_stochasticity: true  # Stochastic for exploration

# -----------------------------------------------------------------
# Code evaluation parameters - Extended resources
# -----------------------------------------------------------------
evaluation:
  timeout: 45                # Longer timeout for complex solutions
  max_memory_mb: 1024        # More memory
  enable_sandboxing: true
  kill_on_timeout: true
  capture_stderr: true

# -----------------------------------------------------------------
# COMPARISON NOTES
# -----------------------------------------------------------------
# This config differs from black_hole_stage2.yaml ONLY in the
# viral_transfer section. All other parameters are identical.
#
# Expected improvements with viral transfer:
# - Faster convergence (reach target fitness in fewer generations)
# - Better cross-island mixing (innovations spread globally)
# - Higher final fitness (more optimization opportunities)
# - Maintain diversity (additive infections, not disruptive)
#
# Timeline comparison:
# - Viral infection: Every 2 generations (rapid spread)
# - Migration: Every 5 generations (population mixing)
# - Result: Complementary mechanisms for innovation propagation
#
# What to watch in logs:
# - "Viral transfer system initialized"
# - "Extracted N viral vectors from M donors"
# - "Infected K individuals in generation X"
# - "Cross-island infections: Y"
